#!/usr/bin/make -f

CFLAGS = -g -Wall -Wextra $(if $(findstring noopt,$(DEB_BUILD_OPTIONS)),-O0,-O2)
LDFLAGS= -Wl,-z,defs

DEB_BUILD_ARCH ?= $(shell dpkg-architecture -qDEB_BUILD_ARCH)

libpkg = $(shell  sed -ne 's/Package: *\(.*\)-dev/\1/p' debian/control)

%:
	dh $@ --parallel

override_dh_installchangelogs:
	dh_installchangelogs ChangeLog

override_dh_auto_configure:
	dh_auto_configure -- \
	    --enable-devel --enable-lzo --enable-lzma \
	    CFLAGS="$(CFLAGS)" LDFLAGS="$(LDFLAGS)"

override_dh_auto_test:
	$(if $(findstring $(DEB_BUILD_ARCH),armel)$(findstring nocheck,$(DEB_BUILD_OPTIONS)),,$(MAKE) check)

override_dh_shlibdeps:
	dh_shlibdeps -L$(libpkg) -ldebian/$(libpkg)/usr/lib

clean:
	dh $@
	! test -e Makefile || $(MAKE) CCACHE_DIR="$$(mktemp -u --suffix=fake-ccache)" distclean
	rm -f build-*-stamp

override_dh_strip:
	dh_strip --dbg-package=kyotocabinet-dbg

